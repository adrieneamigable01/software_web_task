<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Enrollee</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="../css/styles.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    </head>
    <body class="sb-nav-fixed">
        <div w3-include-html="nav.html"></div>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <div w3-include-html="sidenav.html"></div>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-4">Users Tables</h1>
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                            <li class="breadcrumb-item active">Users</li>
                        </ol>
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-table me-1"></i>
                                Users Table
                                <button class="btn btn-primary btn-sm float-end" id="create-user-button" data-bs-toggle="modal" data-bs-target="#user-modal"> Create </button>
                            </div>
                            <div class="card-body">
                                <table class="table" id="table-users">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>UserType</th>
                                            <th>Email</th>
                                            <th>Date Created</th>
                                            <th>-</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>UserType</th>
                                            <th>Email</th>
                                            <th>Date Created</th>
                                            <th>-</th>
                                        </tr>
                                    </tfoot>
                                    <tbody>
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
                <div w3-include-html="footer.html"></div>
                <!-- Modal -->
                <div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Create User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="user_form">
                            <div class="modal-body">
                                
                                    <div class="row mb-3">
                                        <p class="fw-lighter">User Details</p>
                                        <div class="col-md-4 mb-3">
                                            <div class="form-floating mb-3 mb-md-0">
                                                <input class="form-control" value="" id="firstname" name="firstname" type="text" placeholder="Enter your first name" />
                                                <label for="firstname">First name</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="form-floating mb-3 mb-md-0">
                                                <input class="form-control" value="" id="middlename" name="middlename" type="text" placeholder="Enter your first name" />
                                                <label for="middlename">Middle name</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-floating">
                                                <input class="form-control" value="" id="lastname" name="lastname" type="text" placeholder="Enter your last name" />
                                                <label for="lastname">Last name</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-12 mb-3">
                                            <div class="form-floating">
                                                <select class="form-control" id="user_type" name="user_type" type="text"/>
                                                    <option value="Admission Admin">Admission Admin</option>
                                                    <option value="Principal">Principal</option>
                                                </select>
                                                <label for="lastname">User Type</label>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <div class="form-floating">
                                                <input class="form-control" value="" id="email" name="email" type="email" placeholder="name@example.com" />
                                                <label for="email">Email address</label>
                                            </div>
                                        </div>
                                    </div>
                            
                            </div>
                            <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
        <script src="https://use.fontawesome.com/3f0c82a4e2.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="../js/constant.js"></script>
        <script src="../js/scripts.js"></script>
        <script src="../js/jquery-2.2.4.min.js"></script>
        <script src="../js/jquery.validate.js"></script>
        <script src="../js/additional-methods.js"></script>
        <script src="../js/sweetalert2@7.26.11.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
        <script src="../js/checker.js"></script>
        <script>
            var userTable;
            var isCreate = true;
            var userId;
            var user_list = {
                init:()=>{
                    user_list.ajaxz.get_list();
                },
                message:{
                    showQuickMessage:(type = "success",message = "Done")=>{
                        Swal.fire({
                            position: 'top-end',
                            type: type,
                            title: message,
                            showConfirmButton: false,
                            timer: 1500
                        }).then(()=>{
                            
                        })
                    },
                    
                },
                ajaxz:{
                    get_list:()=>{
                        $.ajax({
                            type:'get',
                            url:get_user_list,
                            dataType:'json',
                            beforeSend:function(){
                                $("#table-users tbody").html("");
                            },
                            success:function(response){

                                if (  $.fn.DataTable.isDataTable( '#table-users' ) ) {
                                    userTable.clear();
                                    userTable.destroy();
                                }


                                if(!response.isError){
                                    // <th>Name of Child</th>
                                    // <th>Birthday</th>
                                    // <th>LRN or Student ID</th>
                                    // <th>Parent Name</th>
                                    // <th>Parent Contact Number</th>
                                    // <th>Parent Email Address</th>
                                    // <th>Parent Relationship</th>
                                    new Promise((res,rej)=>{
                                        $.each(response.data,function(key,value){
                                            let name = `${value.firstname} ${value.middlename} ${value.firstname}`;
                                            
                                            $("#table-users tbody").append(
                                                $("<tr>").append(
                                                    $("<td>").text(value.id),
                                                    $("<td>").text(name),
                                                    $("<td>").text(value.user_type),
                                                    $("<td>").text(value.email),
                                                    $("<td>").text(value.date_created),
                                                    $("<td>")
                                                        .addClass("btn-group")    
                                                        .append(
                                                        $("<button>")
                                                                .append(
                                                                    $("<i>")
                                                                        .addClass("fa fa-pencil")
                                                                )
                                                                .addClass("btn btn-success btn-sm")
                                                                .click(function(){
                                                                    userId = value.id;
                                                                    isCreate = false;
                                                                    $("#exampleModalLabel").text("Update User")
                                                                    $("#user_form").find(":input[name=firstname]").val(value.firstname); 
                                                                    $("#user_form").find(":input[name=middlename]").val(value.middlename);
                                                                    $("#user_form").find(":input[name=lastname]").val(value.lastname);
                                                                    $("#user_form").find(":input[name=user_type]").val(value.user_type);
                                                                    $("#user_form").find(":input[name=email]").val(value.email);
                                                                    $("#user-modal").modal("show");
                                                                }),
                                                        $("<button>")
                                                                .append(
                                                                    $("<i>")
                                                                        .addClass("fa fa-trash")
                                                                )
                                                                .addClass("btn btn-danger btn-sm")
                                                                .click(function(){
                                                                    userId = value.id;
                                                                    Swal.fire({
                                                                    title: 'Are you sure?',
                                                                    text: "You won't be able to revert this!",
                                                                    type: 'warning',
                                                                    showCancelButton: true,
                                                                    confirmButtonColor: '#3085d6',
                                                                    cancelButtonColor: '#d33',
                                                                    confirmButtonText: 'Yes, void it!'
                                                                    }).then((result) => {
                                                                        if (result.value) {
                                                                            let payload = {
                                                                                'user_id':userId,
                                                                            }
                                                                            user_list.ajaxz.void(payload);
                                                                        }
                                                                    })
                                                                }),
                                                    ),
                                                )
                                            );

                                            if(Object.keys(response.data).length - 1 == key){
                                                res(true);
                                            }
                                        });
                                    }).then(()=>{
                                        userTable = $("#table-users").DataTable();
                                    })
                                    
                                }
                            }
                        })
                    },
                    create:(payload)=>{
                        let buttonText =  $("#user_form :input[type='submit']").text();
                        $.ajax({
                            type:'post',
                            url:create_user,
                            dataType:'json',
                            data:payload,
                            beforeSend:function(){
                                $("#user_form :input").attr({'disabled':true});
                                $("#user_form :input[type='submit']").text("");
                                $("#user_form :input[type='submit']").append(
                                    $("<i>").addClass("fa fa-spinner fa-spin")
                                )
                            },
                            success:function(response){
                                
                                $("#user_form :input").attr({'disabled':false});
                                $("#user_form :input[type='submit']").html();
                                $("#user_form :input[type='submit']").text(buttonText);
                                user_list.message.showQuickMessage(!response.isError ? 'success' : 'error',response.message);
                                if(!response.isError){
                                    user_list.ajaxz.get_list();
                                    $("#user_form").trigger('reset');
                                    $(".modal").modal('hide');
                                }
                            }
                        })
                    },
                    update:(payload)=>{
                        let buttonText =  $("#user_form :input[type='submit']").text();
                        $.ajax({
                            type:'post',
                            url:update_user,
                            dataType:'json',
                            data:payload,
                            beforeSend:function(){
                                $("#user_form :input").attr({'disabled':true});
                                $("#user_form :input[type='submit']").text("");
                                $("#user_form :input[type='submit']").append(
                                    $("<i>").addClass("fa fa-spinner fa-spin")
                                )
                            },
                            success:function(response){
                                
                                $("#user_form :input").attr({'disabled':false});
                                $("#user_form :input[type='submit']").html();
                                $("#user_form :input[type='submit']").text(buttonText);
                                user_list.message.showQuickMessage(!response.isError ? 'success' : 'error',response.message);
                                if(!response.isError){
                                    isCreate = true;
                                    $("#user_form").trigger('reset');
                                    user_list.ajaxz.get_list();
                                    $(".modal").modal('hide');
                                }
                            }
                        })
                    },
                    void:(payload)=>{
                        
                        $.ajax({
                            type:'post',
                            url:void_user,
                            dataType:'json',
                            data:payload,
                            beforeSend:function(){
                             
                            },
                            success:function(response){
                                user_list.message.showQuickMessage(!response.isError ? 'success' : 'error',response.message);
                                if(!response.isError){
                                    isCreate = true;
                                    $("#user_form").trigger('reset');
                                    user_list.ajaxz.get_list();
                                }
                            }
                        })
                    }
                }
            }

            user_list.init();

            $("#create-user-button").click(function(){
                $("#user_form").trigger('reset');
                $("#exampleModalLabel").text("Create User")
                isCreate = true;
            })

            $('#user_form').validate({
                errorElement: 'span',
                errorClass: 'text-danger',
                highlight: function (element, errorClass, validClass) {
                $(element).closest('.form-group').addClass("has-warning");
                $(element).closest('.form-group').find("input").addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                $(element).closest('.form-group').removeClass("has-warning");
                $(element).closest('.form-group').find("input").removeClass('is-invalid');
                },
                // 
                rules: {
                    firstname:{
                        required: true,
                    },
                    middlename:{
                        required: true,
                    },
                    lastname:{
                        required: true,
                    },
                    user_type:{
                        required: true,
                    },
                    email:{
                        required: true,
                    },
                },
                submitHandler:function(form)
                {
                    if(isCreate) {
                        let payload = {
                            'firstname': $(form).find(":input[name=firstname]").val(),
                            'middlename': $(form).find(":input[name=middlename]").val(),
                            'lastname': $(form).find(":input[name=lastname]").val(),
                            'user_type': $(form).find(":input[name=user_type]").val(),
                            'email': $(form).find(":input[name=email]").val(),
                        }
                        user_list.ajaxz.create(payload);
                    }else{
                        let payload = {
                            'user_id':userId,
                            'firstname': $(form).find(":input[name=firstname]").val(),
                            'middlename': $(form).find(":input[name=middlename]").val(),
                            'lastname': $(form).find(":input[name=lastname]").val(),
                            'user_type': $(form).find(":input[name=user_type]").val(),
                            'email': $(form).find(":input[name=email]").val(),
                        }
                        user_list.ajaxz.update(payload);
                    }
                }
            })

        </script>
    </body>
</html>
